<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event — signUPsignIN</title>

  <link rel="stylesheet" href="./css/base.css" />
  <link rel="stylesheet" href="./css/layout.css" />
  <link rel="stylesheet" href="./css/components.css" />

  <style>
    .event-header {
      border-left: 4px solid #005CFF;
      padding-left: 16px;
      margin-bottom: 32px;
    }

    .event-header h1 {
      margin: 0 0 6px 0;
    }

    .category-section {
      margin-top: 36px;
    }

    .category-title {
      font-size: 15px;
      font-weight: 600;
      text-transform: uppercase;
      color: #005CFF;
      margin-bottom: 12px;
      letter-spacing: 0.04em;
    }

    .slot-actions {
      margin-top: 12px;
    }

    .signup-form {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .signup-form input {
      width: 100%;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .signup-status {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>

<body>

  <div id="navbar"></div>

  <main class="container">

    <!-- EVENT HEADER -->
    <section class="event-header">
      <h1 id="eventTitle">Loading…</h1>
      <p id="eventMeta" class="helper-text"></p>
      <p id="eventDescription"></p>
    </section>

    <!-- SLOTS -->
    <section id="slotsContainer"></section>

  </main>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";
    import { loadNavbar } from "./js/components/navbar.js";

    loadNavbar();

    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("id");

    const eventTitle = document.getElementById("eventTitle");
    const eventMeta = document.getElementById("eventMeta");
    const eventDescription = document.getElementById("eventDescription");
    const slotsContainer = document.getElementById("slotsContainer");

    document.addEventListener("DOMContentLoaded", () => {
      loadEvent();
      loadSlots();
    });

    /* -------------------------
        LOAD EVENT
    -------------------------- */
    async function loadEvent() {
      const { data, error } = await supabase
        .from("events")
        .select("*")
        .eq("id", eventId)
        .single();

      if (error) {
        eventTitle.textContent = "Event not found";
        return;
      }

      eventTitle.textContent = data.title;
      eventMeta.textContent = new Date(data.start_time).toLocaleString([], {
        weekday: "long",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });

      eventDescription.textContent = data.description || "";
    }

    /* -------------------------
        LOAD SLOTS
    -------------------------- */
    async function loadSlots() {
      slotsContainer.innerHTML = "<p>Loading slots…</p>";

      const { data: slots, error } = await supabase
        .from("slots")
        .select("*, signups(full_name)")
        .eq("event_id", eventId)
        .order("category", { ascending: true })
        .order("sort_order", { ascending: true });

      if (error) {
        slotsContainer.innerHTML = "<p>Error loading slots.</p>";
        return;
      }

      if (!slots.length) {
        slotsContainer.innerHTML = "<p>No volunteer slots available.</p>";
        return;
      }

      renderSlots(slots);
    }

    /* -------------------------
        RENDER SLOTS
    -------------------------- */
    function renderSlots(slots) {
      slotsContainer.innerHTML = "";

      const grouped = {};

      slots.forEach(slot => {
        const category = slot.category || "Other";
        if (!grouped[category]) grouped[category] = [];
        grouped[category].push(slot);
      });

      Object.keys(grouped).forEach(category => {
        const section = document.createElement("div");
        section.className = "category-section";

        section.innerHTML = `
          <div class="category-title">${category}</div>
        `;

        grouped[category].forEach(slot => {
          const taken = slot.signups?.length || 0;
          const remaining = slot.quantity_total - taken;
          const disabled = remaining <= 0;

          const card = document.createElement("article");
          card.className = "card";

          card.innerHTML = `
            <h3>${slot.name}</h3>

            ${
              slot.start_time
                ? `<p><strong>${formatTime(slot.start_time)} – ${formatTime(slot.end_time)}</strong></p>`
                : ""
            }

            <p>${remaining > 0 ? `<strong>${remaining}</strong> spots remaining` : `<strong>Full</strong>`}</p>

            <div class="slot-actions">
              ${
                disabled
                  ? `<button class="btn btn-disabled" disabled>Full</button>`
                  : `<button class="btn btn-primary signup-btn">Sign Up</button>`
              }
            </div>

            ${
              !disabled
                ? `
                <form class="signup-form" style="display:none;">
                  <input type="text" placeholder="Your name" required />
                  <input type="email" placeholder="Your email" required />
                  <button class="btn btn-secondary submit-btn">Confirm</button>
                  <div class="signup-status"></div>
                </form>
                `
                : ""
            }
          `;

          if (!disabled) {
            const signupBtn = card.querySelector(".signup-btn");
            const form = card.querySelector(".signup-form");
            const submitBtn = card.querySelector(".submit-btn");
            const statusEl = card.querySelector(".signup-status");

            signupBtn.addEventListener("click", () => {
              form.style.display = form.style.display === "none" ? "block" : "none";
            });

            submitBtn.addEventListener("click", async (e) => {
              e.preventDefault();

              const name = form.querySelector("input[type=text]").value.trim();
              const email = form.querySelector("input[type=email]").value.trim();

              if (!name || !email) {
                statusEl.textContent = "Please enter name and email.";
                return;
              }

              statusEl.textContent = "Submitting…";

              // Re-check capacity
              const { data: fresh } = await supabase
                .from("slots")
                .select("quantity_total, signups(count)")
                .eq("id", slot.id)
                .single();

              if (fresh.signups.length >= fresh.quantity_total) {
                alert("Sorry — this slot just filled up.");
                loadSlots();
                return;
              }

              const { error } = await supabase
                .from("signups")
                .insert({
                  slot_id: slot.id,
                  full_name: name,
                  email: email
                });

              if (error) {
                statusEl.textContent = "Error submitting signup.";
                return;
              }

              loadSlots();
            });
          }

          section.appendChild(card);
        });

        slotsContainer.appendChild(section);
      });
    }

    /* -------------------------
        HELPERS
    -------------------------- */
    function formatTime(val) {
      if (!val) return "";
      const [h, m] = val.split(":");
      const hour = parseInt(h, 10);
      const suffix = hour >= 12 ? "PM" : "AM";
      const displayHour = ((hour + 11) % 12 + 1);
      return `${displayHour}:${m} ${suffix}`;
    }
  </script>

</body>
</html>
