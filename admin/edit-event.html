<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Event — signUPsignIN</title>

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />

  <style>
    .page-header {
      margin-bottom: 32px;
    }

    .page-header h1 {
      margin-top: 12px;
      margin-bottom: 4px;
    }

    .slot-form {
      background: var(--surface);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 32px;
      max-width: 650px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    input,
    textarea,
    select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 15px;
    }

    textarea {
      height: 70px;
      resize: vertical;
    }

    .button-row {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .category-header-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 32px;
      margin-bottom: 12px;
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 92, 255, 0.08);
      color: #005CFF;
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .slot-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .slot-meta {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <div id="navbar"></div>

  <main class="container">

    <!-- EVENT HEADER -->
    <section class="page-header">
      <a class="btn btn-light" href="events.html">← Back to Events</a>
      <h1 id="eventTitle">Loading…</h1>
      <p id="eventDate" class="helper-text"></p>
    </section>

    <!-- SLOT CREATION / EDIT FORM -->
    <section class="slot-form">
      <h2>Add / Edit Slot</h2>

      <label for="slotName">Slot Name</label>
      <input type="text" id="slotName" placeholder="Example: Grill Station" />

      <label for="slotCategory">Category</label>
      <input type="text" id="slotCategory" placeholder="Example: Concessions" />

      <label for="slotQty">Quantity</label>
      <input type="number" id="slotQty" min="1" value="1" />

      <label for="slotStart">Start Time (optional)</label>
      <input type="datetime-local" id="slotStart" />

      <label for="slotEnd">End Time (optional)</label>
      <input type="datetime-local" id="slotEnd" />

      <label for="slotNotes">Notes (optional)</label>
      <textarea id="slotNotes" placeholder="Details, duties, etc."></textarea>

      <div class="button-row">
        <button id="addSlotBtn" class="btn btn-primary">Add Slot</button>
        <button id="updateSlotBtn" class="btn btn-secondary" style="display:none;">Update Slot</button>
        <button id="cancelEditBtn" class="btn btn-light" style="display:none;">Cancel</button>
      </div>

      <p id="slotFormStatus" class="helper-text" style="margin-top:12px;"></p>
    </section>

    <!-- CATEGORY MANAGEMENT -->
    <section class="slot-form">
      <h2>Manage Categories</h2>

      <label for="categorySelect">Existing Category</label>
      <select id="categorySelect">
        <option value="">Select a category…</option>
      </select>

      <label for="newCategoryName">New Category Name</label>
      <input type="text" id="newCategoryName" placeholder="Enter new category name" />

      <div class="button-row">
        <button id="renameCategoryBtn" class="btn btn-secondary">Rename Category</button>
      </div>

      <p id="categoryStatus" class="helper-text" style="margin-top:12px;"></p>
    </section>

    <!-- SLOT LIST -->
    <section id="slotList"></section>

  </main>

  <script type="module">
    import { supabase } from "../js/supabaseClient.js";
    import { loadNavbar } from "../js/components/navbar.js";

    loadNavbar();

    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("id");

    const eventTitle = document.getElementById("eventTitle");
    const eventDate = document.getElementById("eventDate");

    const slotListEl = document.getElementById("slotList");
    const statusEl = document.getElementById("slotFormStatus");

    const addSlotBtn = document.getElementById("addSlotBtn");
    const updateSlotBtn = document.getElementById("updateSlotBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const categorySelect = document.getElementById("categorySelect");
    const newCategoryNameInput = document.getElementById("newCategoryName");
    const categoryStatus = document.getElementById("categoryStatus");

    let editSlotId = null;
    let currentCategories = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadEvent();
      loadSlots();
    });

    /* -------------------------
        LOAD EVENT DATA
    -------------------------- */
    async function loadEvent() {
      const { data, error } = await supabase
        .from("events")
        .select("*")
        .eq("id", eventId)
        .single();

      if (error) {
        console.error(error);
        eventTitle.textContent = "Event not found";
        return;
      }

      eventTitle.textContent = data.title;
      eventDate.textContent = new Date(data.start_time).toLocaleString([], {
        weekday: "long",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });
    }

    /* -------------------------
        LOAD & DISPLAY SLOTS
    -------------------------- */
    async function loadSlots() {
      slotListEl.innerHTML = "<p>Loading slots…</p>";
      currentCategories = [];
      populateCategorySelect(); // clear it

      const { data, error } = await supabase
        .from("slots")
        .select("*, signups(full_name)")
        .eq("event_id", eventId)
        .order("category", { ascending: true })
        .order("start_time", { ascending: true });

      if (error) {
        console.error(error);
        slotListEl.innerHTML = "<p>Error loading slots.</p>";
        return;
      }

      if (!data.length) {
        slotListEl.innerHTML = "<p>No slots added yet.</p>";
        return;
      }

      renderSlots(data);
    }

    function renderSlots(slots) {
      slotListEl.innerHTML = "";

      const grouped = {};
      slots.forEach(slot => {
        const cat = slot.category || "Uncategorized";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(slot);
      });

      const categories = Object.keys(grouped);
      currentCategories = categories;
      populateCategorySelect();

      categories.forEach(category => {
        slotListEl.innerHTML += `
          <div class="category-header-row">
            <span class="category-badge">${category}</span>
          </div>
        `;

        grouped[category].forEach(slot => {
          const taken = slot.signups?.length || 0;
          const remaining = slot.quantity_total - taken;

          slotListEl.innerHTML += `
            <article class="card">
              <h3>${slot.name}</h3>

              ${
                slot.start_time
                  ? `<p><strong>${formatTime(slot.start_time)} – ${formatTime(slot.end_time)}</strong></p>`
                  : ""
              }

              <p><strong>${remaining}</strong> spots remaining</p>
              <p class="slot-meta">Filled: ${taken} / ${slot.quantity_total}</p>

              <div class="slot-card-actions">
                <button class="btn btn-secondary edit-slot-btn" data-id="${slot.id}">Edit</button>
                <button class="btn btn-danger delete-slot-btn" data-id="${slot.id}">Delete</button>
              </div>
            </article>
          `;
        });
      });

      attachSlotButtons();
    }

    /* -------------------------
        SLOT FORM ACTIONS
    -------------------------- */
    addSlotBtn.addEventListener("click", async () => {
      statusEl.textContent = "Adding slot…";

      const payload = getFormValues();

      if (!payload.name || !payload.category) {
        statusEl.textContent = "Slot name and category are required.";
        return;
      }

      const { error } = await supabase
        .from("slots")
        .insert({ ...payload, event_id: eventId });

      if (error) {
        console.error(error);
        statusEl.textContent = "Error adding slot.";
        return;
      }

      resetForm();
      await loadSlots();
      statusEl.textContent = "Slot added!";
    });

    cancelEditBtn.addEventListener("click", () => {
      resetForm();
      statusEl.textContent = "";
    });

    function attachSlotButtons() {
      document.querySelectorAll(".edit-slot-btn").forEach(btn => {
        btn.addEventListener("click", () => startSlotEdit(btn.dataset.id));
      });

      document.querySelectorAll(".delete-slot-btn").forEach(btn => {
        btn.addEventListener("click", () => deleteSlot(btn.dataset.id));
      });
    }

    async function startSlotEdit(slotId) {
      editSlotId = slotId;
      statusEl.textContent = "Editing slot…";

      const { data: slot, error } = await supabase
        .from("slots")
        .select("*")
        .eq("id", slotId)
        .single();

      if (error) {
        console.error(error);
        statusEl.textContent = "Error loading slot for edit.";
        return;
      }

      document.getElementById("slotName").value = slot.name || "";
      document.getElementById("slotCategory").value = slot.category || "";
      document.getElementById("slotQty").value = slot.quantity_total || 1;
      document.getElementById("slotStart").value = slot.start_time || "";
      document.getElementById("slotEnd").value = slot.end_time || "";
      document.getElementById("slotNotes").value = slot.notes || "";

      addSlotBtn.style.display = "none";
      updateSlotBtn.style.display = "inline-flex";
      cancelEditBtn.style.display = "inline-flex";
    }

    updateSlotBtn.addEventListener("click", async () => {
      if (!editSlotId) return;

      statusEl.textContent = "Updating slot…";

      const payload = getFormValues();

      const { error } = await supabase
        .from("slots")
        .update(payload)
        .eq("id", editSlotId);

      if (error) {
        console.error(error);
        statusEl.textContent = "Error updating slot.";
        return;
      }

      resetForm();
      await loadSlots();
      statusEl.textContent = "Slot updated!";
    });

    async function deleteSlot(slotId) {
      if (!confirm("Delete this slot?")) return;

      const { error } = await supabase
        .from("slots")
        .delete()
        .eq("id", slotId);

      if (error) {
        console.error(error);
        alert("Error deleting slot.");
        return;
      }

      await loadSlots();
    }

    /* -------------------------
        CATEGORY MANAGEMENT
    -------------------------- */
    function populateCategorySelect() {
      categorySelect.innerHTML = '<option value="">Select a category…</option>';

      currentCategories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    document.getElementById("renameCategoryBtn").addEventListener("click", async () => {
      const oldCat = categorySelect.value;
      const newCat = newCategoryNameInput.value.trim();

      if (!oldCat) {
        categoryStatus.textContent = "Please select a category to rename.";
        return;
      }
      if (!newCat) {
        categoryStatus.textContent = "Please enter a new category name.";
        return;
      }
      if (oldCat === newCat) {
        categoryStatus.textContent = "Old and new names are the same.";
        return;
      }

      categoryStatus.textContent = "Renaming category…";

      const { error } = await supabase
        .from("slots")
        .update({ category: newCat })
        .eq("event_id", eventId)
        .eq("category", oldCat);

      if (error) {
        console.error(error);
        categoryStatus.textContent = "Error renaming category.";
        return;
      }

      newCategoryNameInput.value = "";
      await loadSlots();
      categoryStatus.textContent = `Category "${oldCat}" renamed to "${newCat}".`;
    });

    /* -------------------------
        HELPERS
    -------------------------- */
    function getFormValues() {
      return {
        name: document.getElementById("slotName").value.trim(),
        category: document.getElementById("slotCategory").value.trim() || "Uncategorized",
        quantity_total: parseInt(document.getElementById("slotQty").value, 10) || 1,
        start_time: document.getElementById("slotStart").value || null,
        end_time: document.getElementById("slotEnd").value || null,
        notes: document.getElementById("slotNotes").value.trim()
      };
    }

    function resetForm() {
      editSlotId = null;

      document.getElementById("slotName").value = "";
      document.getElementById("slotCategory").value = "";
      document.getElementById("slotQty").value = "1";
      document.getElementById("slotStart").value = "";
      document.getElementById("slotEnd").value = "";
      document.getElementById("slotNotes").value = "";

      addSlotBtn.style.display = "inline-flex";
      updateSlotBtn.style.display = "none";
      cancelEditBtn.style.display = "none";
    }

    function formatTime(value) {
      return new Date(value).toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit"
      });
    }
  </script>

</body>
</html>
