<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Event — signUPsignIN</title>

  <link rel="stylesheet" href="../css/base.css" />
  <link rel="stylesheet" href="../css/layout.css" />
  <link rel="stylesheet" href="../css/components.css" />

  <style>
    .page-header {
      margin-bottom: 32px;
    }

    .slot-form {
      background: var(--surface);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      margin-bottom: 32px;
      max-width: 650px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 16px;
      margin-bottom: 6px;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 15px;
    }

    textarea {
      height: 70px;
      resize: vertical;
    }

    .button-row {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .category-header-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 32px;
      margin-bottom: 12px;
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(0, 92, 255, 0.1);
      color: #005CFF;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .slot-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }

    .slot-meta {
      font-size: 13px;
      color: #666;
      margin-top: 6px;
    }
  </style>
</head>

<body>

  <div id="navbar"></div>

  <main class="container">

    <!-- EVENT HEADER -->
    <section class="page-header">
      <a class="btn btn-light" href="events.html">← Back to Events</a>
      <h1 id="eventTitle">Loading…</h1>
      <p id="eventDate" class="helper-text"></p>
    </section>

    <!-- SLOT FORM -->
    <section class="slot-form">
      <h2>Add / Edit Slot</h2>

      <label>Slot Name</label>
      <input type="text" id="slotName" placeholder="Example: Grill Station" />

      <label>Category</label>
      <input type="text" id="slotCategory" placeholder="Example: Concessions" />

      <label>Quantity</label>
      <input type="number" id="slotQty" min="1" value="1" />

      <label>Start Time (optional)</label>
      <input type="datetime-local" id="slotStart" />

      <label>End Time (optional)</label>
      <input type="datetime-local" id="slotEnd" />

      <label>Notes (optional)</label>
      <textarea id="slotNotes" placeholder="Details, duties, etc."></textarea>

      <div class="button-row">
        <button id="addSlotBtn" class="btn btn-primary">Add Slot</button>
        <button id="updateSlotBtn" class="btn btn-secondary" style="display:none;">Update Slot</button>
        <button id="cancelEditBtn" class="btn btn-light" style="display:none;">Cancel</button>
      </div>

      <p id="slotFormStatus" class="helper-text" style="margin-top:12px;"></p>
    </section>

    <!-- CATEGORY MANAGEMENT -->
    <section class="slot-form">
      <h2>Manage Categories</h2>

      <label>Existing Category</label>
      <select id="categorySelect">
        <option value="">Select a category…</option>
      </select>

      <label>New Category Name</label>
      <input type="text" id="newCategoryName" placeholder="Enter new category name" />

      <div class="button-row">
        <button id="renameCategoryBtn" class="btn btn-secondary">Rename Category</button>
      </div>

      <p id="categoryStatus" class="helper-text" style="margin-top:12px;"></p>
    </section>

    <!-- SLOT LIST -->
    <section id="slotList"></section>

  </main>

  <script type="module">
    import { supabase } from "../js/supabaseClient.js";
    import { loadNavbar } from "../js/components/navbar.js";

    loadNavbar();

    const params = new URLSearchParams(window.location.search);
    const eventId = params.get("id");

    const eventTitle = document.getElementById("eventTitle");
    const eventDate = document.getElementById("eventDate");

    const slotListEl = document.getElementById("slotList");
    const statusEl = document.getElementById("slotFormStatus");

    const addSlotBtn = document.getElementById("addSlotBtn");
    const updateSlotBtn = document.getElementById("updateSlotBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const categorySelect = document.getElementById("categorySelect");
    const newCategoryNameInput = document.getElementById("newCategoryName");
    const categoryStatus = document.getElementById("categoryStatus");

    let editSlotId = null;
    let currentCategories = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadEvent();
      loadSlots();
    });

    /* -------------------------
        LOAD EVENT
    -------------------------- */
    async function loadEvent() {
      const { data, error } = await supabase
        .from("events")
        .select("*")
        .eq("id", eventId)
        .single();

      if (error) return;

      eventTitle.textContent = data.title;
      eventDate.textContent = new Date(data.start_time).toLocaleString([], {
        weekday: "long",
        month: "long",
        day: "numeric",
        hour: "numeric",
        minute: "2-digit"
      });
    }

    /* -------------------------
        LOAD SLOTS
    -------------------------- */
    async function loadSlots() {
      slotListEl.innerHTML = "<p>Loading slots...</p>";

      const { data, error } = await supabase
        .from("slots")
        .select("*, signups(full_name)")
        .eq("event_id", eventId)
        .order("category", { ascending: true })
        .order("sort_order", { ascending: true });

      if (error) {
        slotListEl.innerHTML = "<p>Error loading slots.</p>";
        return;
      }

      if (!data.length) {
        slotListEl.innerHTML = "<p>No slots yet.</p>";
        return;
      }

      renderSlots(data);
    }

    function renderSlots(slots) {
      slotListEl.innerHTML = "";
      currentCategories = [];

      const grouped = {};
      slots.forEach(slot => {
        const cat = slot.category || "Uncategorized";
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(slot);
      });

      currentCategories = Object.keys(grouped);
      populateCategorySelect();

      currentCategories.forEach(category => {
        slotListEl.innerHTML += `
          <div class="category-header-row">
            <span class="category-badge">${category}</span>
          </div>
        `;

        grouped[category].forEach((slot, index) => {
          const taken = slot.signups?.length || 0;
          const remaining = slot.quantity_total - taken;

          slotListEl.innerHTML += `
            <article class="card">
              <h3>${slot.name}</h3>

              ${
                slot.start_time
                  ? `<p><strong>${formatTime(slot.start_time)} – ${formatTime(slot.end_time)}</strong></p>`
                  : ""
              }

              <p><strong>${remaining}</strong> spots remaining</p>
              <p class="slot-meta">Filled: ${taken} / ${slot.quantity_total}</p>

              <div class="slot-card-actions">

                <button class="btn btn-light move-up-btn"
                        data-id="${slot.id}"
                        data-category="${slot.category}">
                  ↑ Move Up
                </button>

                <button class="btn btn-light move-down-btn"
                        data-id="${slot.id}"
                        data-category="${slot.category}">
                  ↓ Move Down
                </button>

                <button class="btn btn-light duplicate-slot-btn"
                        data-id="${slot.id}">
                Duplicate
                </button>

                <button class="btn btn-secondary edit-slot-btn"
                        data-id="${slot.id}">
                  Edit
                </button>

                <button class="btn btn-danger delete-slot-btn"
                        data-id="${slot.id}">
                  Delete
                </button>

              </div>
            </article>
          `;
        });
      });

      attachSlotButtons();
    }

    /* -------------------------
        ADD SLOT
    -------------------------- */
    addSlotBtn.addEventListener("click", async () => {
      statusEl.textContent = "Adding slot...";

      const payload = getFormValues();
      if (!payload.name || !payload.category) {
        statusEl.textContent = "Name and category required.";
        return;
      }

      // Find highest sort_order in category
      const { data: existing } = await supabase
        .from("slots")
        .select("sort_order")
        .eq("event_id", eventId)
        .eq("category", payload.category)
        .order("sort_order", { ascending: false })
        .limit(1);

      const lastOrder = existing && existing.length > 0 ? existing[0].sort_order : 0;
      payload.sort_order = lastOrder + 1;

      const { error } = await supabase
        .from("slots")
        .insert({ ...payload, event_id: eventId });

      if (error) {
  console.error("SUPABASE ERROR:", error);
  console.error("PAYLOAD THAT FAILED:", payload);
  statusEl.textContent = "Error adding slot.";
  return;
}

      resetForm();
      loadSlots();
      statusEl.textContent = "Slot added!";
    });

    /* -------------------------
        EDIT SLOT
    -------------------------- */
    function attachSlotButtons() {
      document.querySelectorAll(".edit-slot-btn").forEach(btn => {
        btn.addEventListener("click", () => startSlotEdit(btn.dataset.id));
      });

      document.querySelectorAll(".delete-slot-btn").forEach(btn => {
        btn.addEventListener("click", () => deleteSlot(btn.dataset.id));
      });

      document.querySelectorAll(".move-up-btn").forEach(btn => {
        btn.addEventListener("click", () =>
          moveSlot(btn.dataset.id, btn.dataset.category, "up")
        );
      });

      document.querySelectorAll(".move-down-btn").forEach(btn => {
        btn.addEventListener("click", () =>
          moveSlot(btn.dataset.id, btn.dataset.category, "down")
        );
      });

      document.querySelectorAll(".duplicate-slot-btn").forEach(btn => {
        btn.addEventListener("click", () => duplicateSlot(btn.dataset.id));
      });
      
    }

    async function startSlotEdit(slotId) {
      editSlotId = slotId;

      const { data: slot } = await supabase
        .from("slots")
        .select("*")
        .eq("id", slotId)
        .single();

      document.getElementById("slotName").value = slot.name;
      document.getElementById("slotCategory").value = slot.category;
      document.getElementById("slotQty").value = slot.quantity_total;
      document.getElementById("slotStart").value = slot.start_time || "";
      document.getElementById("slotEnd").value = slot.end_time || "";
      document.getElementById("slotNotes").value = slot.notes || "";

      addSlotBtn.style.display = "none";
      updateSlotBtn.style.display = "inline-flex";
      cancelEditBtn.style.display = "inline-flex";

      statusEl.textContent = "Editing slot...";
    }

    updateSlotBtn.addEventListener("click", async () => {
      const payload = getFormValues();

      const { error } = await supabase
        .from("slots")
        .update(payload)
        .eq("id", editSlotId);

      if (error) {
        statusEl.textContent = "Error updating slot.";
        return;
      }

      resetForm();
      loadSlots();
      statusEl.textContent = "Slot updated!";
    });

    cancelEditBtn.addEventListener("click", () => {
      resetForm();
      statusEl.textContent = "";
    });

    /* -------------------------
        DELETE SLOT
    -------------------------- */
    async function deleteSlot(slotId) {
      if (!confirm("Delete this slot?")) return;

      await supabase.from("slots").delete().eq("id", slotId);
      loadSlots();
    }

    /* -------------------------
        REORDER SLOTS
    -------------------------- */
    async function moveSlot(slotId, category, direction) {
      const { data: slots } = await supabase
        .from("slots")
        .select("*")
        .eq("event_id", eventId)
        .eq("category", category)
        .order("sort_order", { ascending: true });

      const index = slots.findIndex(s => s.id == slotId);
      if (index === -1) return;

      const swapIndex = direction === "up" ? index - 1 : index + 1;
      if (swapIndex < 0 || swapIndex >= slots.length) return;

      const slotA = slots[index];
      const slotB = slots[swapIndex];

      await Promise.all([
        supabase.from("slots").update({ sort_order: slotB.sort_order }).eq("id", slotA.id),
        supabase.from("slots").update({ sort_order: slotA.sort_order }).eq("id", slotB.id)
      ]);

      loadSlots();
    }

    /* -------------------------
        CATEGORY RENAME
    -------------------------- */
    function populateCategorySelect() {
      categorySelect.innerHTML = '<option value="">Select a category…</option>';

      currentCategories.forEach(cat => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    document.getElementById("renameCategoryBtn").addEventListener("click", async () => {
      const oldCat = categorySelect.value;
      const newCat = newCategoryNameInput.value.trim();

      if (!oldCat || !newCat) {
        categoryStatus.textContent = "Select a category and enter a new name.";
        return;
      }

      await supabase
        .from("slots")
        .update({ category: newCat })
        .eq("event_id", eventId)
        .eq("category", oldCat);

      newCategoryNameInput.value = "";
      loadSlots();

      categoryStatus.textContent = `Renamed "${oldCat}" → "${newCat}"`;
    });

    /* -------------------------
        HELPERS
    -------------------------- */

    function extractTime(val) {
  if (!val) return null;
  // val looks like "2025-01-01T17:30"
  const parts = val.split("T")[1]; 
  return parts ? parts + ":00" : null; 
}
    
    function getFormValues() {
  return {
    name: document.getElementById("slotName").value.trim(),
    category: document.getElementById("slotCategory").value.trim(),
    quantity_total: parseInt(document.getElementById("slotQty").value),
    start_time: extractTime(document.getElementById("slotStart").value),
    end_time: extractTime(document.getElementById("slotEnd").value),
    description: document.getElementById("slotNotes").value.trim()
  };
}

    function resetForm() {
      editSlotId = null;

      document.getElementById("slotName").value = "";
      document.getElementById("slotCategory").value = "";
      document.getElementById("slotQty").value = "1";
      document.getElementById("slotStart").value = "";
      document.getElementById("slotEnd").value = "";
      document.getElementById("slotNotes").value = "";

      addSlotBtn.style.display = "inline-flex";
      updateSlotBtn.style.display = "none";
      cancelEditBtn.style.display = "none";
    }

    function formatTime(value) {
      return new Date(value).toLocaleTimeString([], {
        hour: "numeric",
        minute: "2-digit"
      });
    }

async function duplicateSlot(slotId) {
  // 1. Load the slot we are duplicating
  const { data: slot, error } = await supabase
    .from("slots")
    .select("*")
    .eq("id", slotId)
    .single();

  if (error || !slot) {
    alert("Unable to duplicate slot.");
    return;
  }

  // 2. Find the highest sort_order in this category for this event
  const { data: existing } = await supabase
    .from("slots")
    .select("sort_order")
    .eq("event_id", eventId)
    .eq("category", slot.category)
    .order("sort_order", { ascending: false })
    .limit(1);

  const lastOrder =
    existing && existing.length > 0 ? existing[0].sort_order : 0;

  // 3. Insert duplicated slot
  const { error: insertError } = await supabase
    .from("slots")
    .insert({
      event_id: eventId,
      name: slot.name,
      category: slot.category,
      quantity_total: slot.quantity_total,
      start_time: slot.start_time,
      end_time: slot.end_time,
      description: slot.description,
      sort_order: lastOrder + 1
    });

  if (insertError) {
    console.error(insertError);
    alert("Error duplicating slot.");
    return;
  }

  // 4. Refresh UI
  loadSlots();
}
    
  </script>

</body>
</html>





